version: '3.8'

# ============================================================================
# NETWORKS (Swarm overlay networks)
# ============================================================================
networks:
  location404:
    driver: overlay
    attachable: true
    driver_opts:
      encrypted: "true"
  traefik-public:
    driver: overlay
    attachable: true
    driver_opts:
      encrypted: "true"

# ============================================================================
# VOLUMES
# ============================================================================
volumes:
  traefik-certificates:
  grafana-data:
  loki-data:
  tempo-data:
  mimir-data:
  prometheus-data:

# ============================================================================
# SERVICES
# ============================================================================
services:

  # ==========================================================================
  # TRAEFIK - Reverse Proxy + Load Balancer + SSL
  # ==========================================================================
  traefik:
    image: traefik:v3.0

    command:
      # API & Dashboard
      - "--api.dashboard=true"
      - "--api.insecure=true"

      # Docker Provider (Swarm Mode)
      - "--providers.docker=true"
      - "--providers.docker.swarmMode=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=traefik-public"

      # Entrypoints
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"

      # SSL/TLS (Let's Encrypt para produção)
      - "--certificatesresolvers.letsencrypt.acme.tlschallenge=true"
      - "--certificatesresolvers.letsencrypt.acme.email=${ACME_EMAIL:-admin@location404.com}"
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
      # Para staging/teste, descomente:
      # - "--certificatesresolvers.letsencrypt.acme.caserver=https://acme-staging-v02.api.letsencrypt.org/directory"

      # Logs
      - "--log.level=INFO"
      - "--log.format=json"
      - "--accesslog=true"
      - "--accesslog.format=json"
      - "--accesslog.filepath=/var/log/traefik/access.log"

      # Metrics (Prometheus)
      - "--metrics.prometheus=true"
      - "--metrics.prometheus.addEntryPointsLabels=true"
      - "--metrics.prometheus.addRoutersLabels=true"
      - "--metrics.prometheus.addServicesLabels=true"
      - "--metrics.prometheus.buckets=0.1,0.3,1.2,5.0,10.0"

      # Tracing (OpenTelemetry → Tempo)
      - "--tracing.otlp=true"
      - "--tracing.otlp.grpc.endpoint=tempo:4317"
      - "--tracing.otlp.grpc.insecure=true"

      # Health Check
      - "--ping=true"

    ports:
      - "80:80"       # HTTP
      - "443:443"     # HTTPS
      - "8888:8080"   # Traefik Dashboard (alterado de 8080)

    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
      - "traefik-certificates:/letsencrypt"

    networks:
      - traefik-public
      - location404

    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dashboard.rule=Host(`traefik.${DOMAIN:-location404.local}`)"
      - "traefik.http.routers.dashboard.service=api@internal"
      - "traefik.http.routers.dashboard.entrypoints=websecure"
      - "traefik.http.routers.dashboard.tls=true"
      - "traefik.http.routers.dashboard.tls.certresolver=letsencrypt"

    healthcheck:
      test: ["CMD", "traefik", "healthcheck", "--ping"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      update_config:
        parallelism: 1
        delay: 10s
      restart_policy:
        condition: on-failure
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 128M

  # ==========================================================================
  # FRONTEND - Vue 3 (Auto-scaling com Load Balancing)
  # ==========================================================================
  location404-web:
    image: ${DOCKER_REGISTRY:-ghcr.io/location404}/location404-web:${VERSION:-main}
    build:
      context: ../../location404-web
      dockerfile: Dockerfile
      args:
        VITE_AUTH_API: https://auth.${DOMAIN:-location404.local}
        VITE_GAME_API: https://game.${DOMAIN:-location404.local}
        VITE_DATA_API: https://data.${DOMAIN:-location404.local}
        VITE_GOOGLE_MAPS_API_KEY: ${GOOGLE_MAPS_API_KEY}

    networks:
      - traefik-public
      - location404

    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik-public"

      # Router
      - "traefik.http.routers.web.rule=Host(`${DOMAIN:-location404.local}`) || Host(`www.${DOMAIN:-location404.local}`)"
      - "traefik.http.routers.web.entrypoints=websecure"
      - "traefik.http.routers.web.tls=true"
      - "traefik.http.routers.web.tls.certresolver=letsencrypt"
      - "traefik.http.routers.web.service=web"

      # Load Balancer
      - "traefik.http.services.web.loadbalancer.server.port=3400"
      - "traefik.http.services.web.loadbalancer.sticky.cookie=true"
      - "traefik.http.services.web.loadbalancer.sticky.cookie.name=location404_web"
      - "traefik.http.services.web.loadbalancer.sticky.cookie.httpOnly=true"
      - "traefik.http.services.web.loadbalancer.sticky.cookie.secure=true"
      - "traefik.http.services.web.loadbalancer.healthcheck.path=/"
      - "traefik.http.services.web.loadbalancer.healthcheck.interval=30s"

    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3400"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    deploy:
      mode: replicated
      replicas: 2
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
        order: start-first
      rollback_config:
        parallelism: 1
        delay: 5s
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

  # ==========================================================================
  # GAME ENGINE - SignalR (Redis Backplane + Sticky Sessions)
  # ==========================================================================
  location404-game:
    image: ${DOCKER_REGISTRY:-ghcr.io/location404}/location404-game:${VERSION:-main}
    build:
      context: ../../location404-game
      dockerfile: Dockerfile

    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:8080

      # Redis
      - Redis__Enabled=true
      - Redis__ConnectionString=${REDIS_CONNECTION_STRING}

      # RabbitMQ
      - RabbitMQ__Enabled=true
      - RabbitMQ__HostName=${RABBITMQ_HOST}
      - RabbitMQ__Port=${RABBITMQ_PORT:-5672}
      - RabbitMQ__UserName=${RABBITMQ_USER:-guest}
      - RabbitMQ__Password=${RABBITMQ_PASSWORD:-guest}

      # Location404 Data API
      - Location404Data__BaseUrl=http://location404-data:8080

      # OpenTelemetry
      - OpenTelemetry__ServiceName=location404-game
      - OpenTelemetry__ServiceVersion=1.0.0
      - OpenTelemetry__ServiceNamespace=location404
      - OpenTelemetry__CollectorEndpoint=http://tempo:4317
      - OpenTelemetry__Tracing__Enabled=true
      - OpenTelemetry__Tracing__SamplingRatio=1.0
      - OpenTelemetry__Metrics__Enabled=true
      - OpenTelemetry__Logging__Enabled=true

    networks:
      - traefik-public
      - location404

    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik-public"

      # Router
      - "traefik.http.routers.game.rule=Host(`game.${DOMAIN:-location404.local}`)"
      - "traefik.http.routers.game.entrypoints=websecure"
      - "traefik.http.routers.game.tls=true"
      - "traefik.http.routers.game.tls.certresolver=letsencrypt"
      - "traefik.http.routers.game.service=game"

      # Load Balancer (STICKY SESSION - CRÍTICO para SignalR!)
      - "traefik.http.services.game.loadbalancer.server.port=8080"
      - "traefik.http.services.game.loadbalancer.sticky.cookie=true"
      - "traefik.http.services.game.loadbalancer.sticky.cookie.name=location404_game_sticky"
      - "traefik.http.services.game.loadbalancer.sticky.cookie.httpOnly=true"
      - "traefik.http.services.game.loadbalancer.sticky.cookie.secure=true"
      - "traefik.http.services.game.loadbalancer.sticky.cookie.sameSite=lax"
      - "traefik.http.services.game.loadbalancer.healthcheck.path=/health"
      - "traefik.http.services.game.loadbalancer.healthcheck.interval=10s"

      # CORS Headers (SignalR)
      - "traefik.http.middlewares.game-cors.headers.accesscontrolalloworiginlist=https://${DOMAIN:-location404.local},https://www.${DOMAIN:-location404.local}"
      - "traefik.http.middlewares.game-cors.headers.accesscontrolallowcredentials=true"
      - "traefik.http.middlewares.game-cors.headers.accesscontrolallowmethods=GET,POST,OPTIONS"
      - "traefik.http.middlewares.game-cors.headers.accesscontrolallowheaders=*"
      - "traefik.http.routers.game.middlewares=game-cors"

    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    depends_on:
      - tempo

    deploy:
      mode: replicated
      replicas: 2
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
        order: start-first
      rollback_config:
        parallelism: 1
        delay: 5s
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
      resources:
        limits:
          cpus: '2'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

  # ==========================================================================
  # AUTH SERVICE - JWT Authentication
  # ==========================================================================
  location404-auth:
    image: ${DOCKER_REGISTRY:-ghcr.io/location404}/location404-auth:${VERSION:-main}
    build:
      context: ../../location404-auth
      dockerfile: Dockerfile

    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:8080

      # Database
      - ConnectionStrings__UserIdentityDatabaseProduction=${POSTGRES_AUTH_CONNECTION}

      # JWT
      - JwtSettings__Issuer=location404
      - JwtSettings__Audience=location404
      - JwtSettings__SigningKey=${JWT_SIGNING_KEY}
      - JwtSettings__AccessTokenMinutes=60
      - JwtSettings__RefreshTokenMinutes=10080

      # OpenTelemetry
      - OpenTelemetry__ServiceName=location404-auth
      - OpenTelemetry__ServiceVersion=1.0.0
      - OpenTelemetry__ServiceNamespace=location404
      - OpenTelemetry__CollectorEndpoint=http://tempo:4317
      - OpenTelemetry__Tracing__Enabled=true
      - OpenTelemetry__Tracing__SamplingRatio=1.0
      - OpenTelemetry__Metrics__Enabled=true
      - OpenTelemetry__Logging__Enabled=true

    networks:
      - traefik-public
      - location404

    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik-public"

      # Router
      - "traefik.http.routers.auth.rule=Host(`auth.${DOMAIN:-location404.local}`)"
      - "traefik.http.routers.auth.entrypoints=websecure"
      - "traefik.http.routers.auth.tls=true"
      - "traefik.http.routers.auth.tls.certresolver=letsencrypt"
      - "traefik.http.routers.auth.service=auth"

      # Load Balancer
      - "traefik.http.services.auth.loadbalancer.server.port=8080"
      - "traefik.http.services.auth.loadbalancer.sticky.cookie=true"
      - "traefik.http.services.auth.loadbalancer.sticky.cookie.name=location404_auth"
      - "traefik.http.services.auth.loadbalancer.healthcheck.path=/health"
      - "traefik.http.services.auth.loadbalancer.healthcheck.interval=10s"

    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    depends_on:
      - tempo

    deploy:
      mode: replicated
      replicas: 2
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
        order: start-first
      rollback_config:
        parallelism: 1
        delay: 5s
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
      resources:
        limits:
          cpus: '1'
          memory: 768M
        reservations:
          cpus: '0.25'
          memory: 384M

  # ==========================================================================
  # DATA SERVICE - Locations & Stats
  # ==========================================================================
  location404-data:
    image: ${DOCKER_REGISTRY:-ghcr.io/location404}/location404-data:${VERSION:-main}
    build:
      context: ../../location404-data
      dockerfile: Dockerfile

    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:8080

      # Database
      - ConnectionStrings__GeoDataDatabase=${POSTGRES_DATA_CONNECTION}

      # RabbitMQ
      - RabbitMQ__Enabled=true
      - RabbitMQ__HostName=${RABBITMQ_HOST}
      - RabbitMQ__Port=${RABBITMQ_PORT:-5672}
      - RabbitMQ__UserName=${RABBITMQ_USER:-guest}
      - RabbitMQ__Password=${RABBITMQ_PASSWORD:-guest}
      - RabbitMQ__MatchEndedQueue=match-ended

      # OpenTelemetry
      - OpenTelemetry__ServiceName=location404-data
      - OpenTelemetry__ServiceVersion=1.0.0
      - OpenTelemetry__ServiceNamespace=location404
      - OpenTelemetry__CollectorEndpoint=http://tempo:4317
      - OpenTelemetry__Tracing__Enabled=true
      - OpenTelemetry__Tracing__SamplingRatio=1.0
      - OpenTelemetry__Metrics__Enabled=true
      - OpenTelemetry__Logging__Enabled=true

    networks:
      - traefik-public
      - location404

    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik-public"

      # Router
      - "traefik.http.routers.data.rule=Host(`data.${DOMAIN:-location404.local}`)"
      - "traefik.http.routers.data.entrypoints=websecure"
      - "traefik.http.routers.data.tls=true"
      - "traefik.http.routers.data.tls.certresolver=letsencrypt"
      - "traefik.http.routers.data.service=data"

      # Load Balancer
      - "traefik.http.services.data.loadbalancer.server.port=8080"
      - "traefik.http.services.data.loadbalancer.healthcheck.path=/health"
      - "traefik.http.services.data.loadbalancer.healthcheck.interval=10s"

    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    depends_on:
      - tempo

    deploy:
      mode: replicated
      replicas: 2
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
        order: start-first
      rollback_config:
        parallelism: 1
        delay: 5s
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
      resources:
        limits:
          cpus: '1'
          memory: 768M
        reservations:
          cpus: '0.25'
          memory: 384M

  # ==========================================================================
  # OBSERVABILITY - Grafana Tempo (Distributed Tracing)
  # ==========================================================================
  tempo:
    image: grafana/tempo:latest

    command: ["-config.file=/etc/tempo.yaml"]

    volumes:
      - ./observability/tempo.yaml:/etc/tempo.yaml
      - tempo-data:/tmp/tempo

    ports:
      - "13200:3200"   # Tempo (alterado de 3200)
      - "14317:4317"   # OTLP gRPC (alterado de 4317)
      - "14318:4318"   # OTLP HTTP (alterado de 4318)

    networks:
      - location404

    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3200/ready"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ==========================================================================
  # OBSERVABILITY - Grafana Loki (Logs Aggregation)
  # ==========================================================================
  loki:
    image: grafana/loki:latest

    command: -config.file=/etc/loki/local-config.yaml

    volumes:
      - ./observability/loki.yaml:/etc/loki/local-config.yaml
      - loki-data:/loki

    ports:
      - "13100:3100"   # Loki (alterado de 3100)

    networks:
      - location404

    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3100/ready"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ==========================================================================
  # OBSERVABILITY - Grafana Mimir (Metrics Storage)
  # ==========================================================================
  mimir:
    image: grafana/mimir:latest

    command: ["-config.file=/etc/mimir.yaml"]

    volumes:
      - ./observability/mimir.yaml:/etc/mimir.yaml
      - mimir-data:/data

    ports:
      - "19009:9009"   # Mimir (alterado de 9009)

    networks:
      - location404

    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9009/ready"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ==========================================================================
  # OBSERVABILITY - Prometheus (Metrics Scraper)
  # ==========================================================================
  prometheus:
    image: prom/prometheus:latest

    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.enable-lifecycle'
      - '--web.enable-remote-write-receiver'

    volumes:
      - ./observability/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-data:/prometheus

    ports:
      - "19090:9090"   # Prometheus (alterado de 9090)

    networks:
      - traefik-public
      - location404

    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.prometheus.rule=Host(`prometheus.${DOMAIN:-location404.local}`)"
      - "traefik.http.routers.prometheus.entrypoints=websecure"
      - "traefik.http.routers.prometheus.tls=true"
      - "traefik.http.routers.prometheus.tls.certresolver=letsencrypt"
      - "traefik.http.services.prometheus.loadbalancer.server.port=9090"

    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ==========================================================================
  # OBSERVABILITY - Grafana (Visualization)
  # ==========================================================================
  grafana:
    image: grafana/grafana:latest

    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-location404}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SERVER_ROOT_URL=https://grafana.${DOMAIN:-location404.local}
      - GF_INSTALL_PLUGINS=grafana-clock-panel,grafana-simple-json-datasource,grafana-piechart-panel
      - GF_FEATURE_TOGGLES_ENABLE=traceqlEditor

    volumes:
      - grafana-data:/var/lib/grafana
      - ./observability/grafana/provisioning:/etc/grafana/provisioning
      - ./observability/grafana/dashboards:/var/lib/grafana/dashboards

    ports:
      - "13000:3000"   # Grafana (alterado de 3000 - conflito com Dokploy)

    networks:
      - traefik-public
      - location404

    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.grafana.rule=Host(`grafana.${DOMAIN:-location404.local}`)"
      - "traefik.http.routers.grafana.entrypoints=websecure"
      - "traefik.http.routers.grafana.tls=true"
      - "traefik.http.routers.grafana.tls.certresolver=letsencrypt"
      - "traefik.http.services.grafana.loadbalancer.server.port=3000"

    depends_on:
      - tempo
      - loki
      - mimir
      - prometheus

    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
