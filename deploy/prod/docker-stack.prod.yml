version: "3.8"

# ============================================================================
# NETWORKS (Swarm overlay networks)
# ============================================================================
networks:
  location404:
    driver: overlay
    attachable: true
    driver_opts:
      encrypted: "true"
  traefik-public:
    driver: overlay
    attachable: true
    driver_opts:
      encrypted: "true"

# ============================================================================
# VOLUMES
# ============================================================================
volumes:
  traefik-certificates:

# ============================================================================
# SERVICES
# ============================================================================
services:
  # ==========================================================================
  # TRAEFIK - Reverse Proxy + Load Balancer + SSL
  # ==========================================================================
  traefik:
    image: traefik:v3.0

    command:
      # API & Dashboard
      - "--api.dashboard=true"
      - "--api.insecure=true"

      # Swarm Provider (Traefik v3)
      - "--providers.swarm=true"
      - "--providers.swarm.endpoint=unix:///var/run/docker.sock"
      - "--providers.swarm.exposedbydefault=false"

      # Entrypoints
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      # Comentado para permitir HTTP sem redirecionar
      # - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      # - "--entrypoints.web.http.redirections.entrypoint.scheme=https"

      # SSL/TLS (Let's Encrypt para produção) - COMENTADO PARA TESTES
      # - "--certificatesresolvers.letsencrypt.acme.tlschallenge=true"
      # - "--certificatesresolvers.letsencrypt.acme.email=${ACME_EMAIL:-admin@location404.com}"
      # - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"

      # Logs
      - "--log.level=DEBUG"
      - "--log.format=json"
      - "--accesslog=true"
      - "--accesslog.format=json"
      - "--accesslog.filepath=/var/log/traefik/access.log"

      # Metrics (Prometheus)
      - "--metrics.prometheus=true"
      - "--metrics.prometheus.addEntryPointsLabels=true"
      - "--metrics.prometheus.addRoutersLabels=true"
      - "--metrics.prometheus.addServicesLabels=true"
      - "--metrics.prometheus.buckets=0.1,0.3,1.2,5.0,10.0"

      # Tracing (OpenTelemetry → External LGTM Stack via Dokploy)
      - "--tracing.otlp=true"
      - "--tracing.otlp.grpc.endpoint=${OTLP_COLLECTOR_ENDPOINT:-181.215.135.221:4320}"
      - "--tracing.otlp.grpc.insecure=true"

      # Health Check
      - "--ping=true"

    ports:
      - "80:80" # HTTP
      - "443:443" # HTTPS
      - "8888:8080" # Traefik Dashboard (alterado de 8080)

    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
      - "traefik-certificates:/letsencrypt"

    networks:
      - traefik-public
      - location404

    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dashboard.rule=Host(`traefik.${DOMAIN:-location404.local}`)"
      - "traefik.http.routers.dashboard.service=api@internal"
      - "traefik.http.routers.dashboard.entrypoints=web"
      # TLS comentado para testes
      # - "traefik.http.routers.dashboard.tls=true"
      # - "traefik.http.routers.dashboard.tls.certresolver=letsencrypt"

    healthcheck:
      test: ["CMD", "traefik", "healthcheck", "--ping"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      update_config:
        parallelism: 1
        delay: 10s
      restart_policy:
        condition: on-failure
      resources:
        limits:
          cpus: "0.5"
          memory: 256M
        reservations:
          cpus: "0.1"
          memory: 128M

  # ==========================================================================
  # FRONTEND - Vue 3 (Load Balancing com Traefik)
  # ==========================================================================
  location404-web:
    image: ${DOCKER_REGISTRY:-ghcr.io/location404}/location404-web:${VERSION:-main}
    build:
      context: ../../location404-web
      dockerfile: Dockerfile
      args:
        VITE_AUTH_API: https://auth.${DOMAIN:-location404.local}
        VITE_GAME_API: https://game.${DOMAIN:-location404.local}
        VITE_DATA_API: https://data.${DOMAIN:-location404.local}
        VITE_GOOGLE_MAPS_API_KEY: ${GOOGLE_MAPS_API_KEY}

    networks:
      - traefik-public
      - location404

    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:3400",
        ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s

    deploy:
      mode: replicated
      replicas: 1
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.web.rule=Host(`${DOMAIN:-location404.local}`) || Host(`www.${DOMAIN:-location404.local}`) || Host(`181.215.135.221`)"
        - "traefik.http.routers.web.entrypoints=web"
        - "traefik.http.routers.web.service=web"
        - "traefik.http.services.web.loadbalancer.server.port=3400"
        - "traefik.http.services.web.loadbalancer.sticky.cookie=true"
        - "traefik.http.services.web.loadbalancer.sticky.cookie.name=location404_web"
        - "traefik.http.services.web.loadbalancer.sticky.cookie.httpOnly=true"
        - "traefik.http.services.web.loadbalancer.sticky.cookie.secure=true"
        - "traefik.http.services.web.loadbalancer.healthcheck.path=/"
        - "traefik.http.services.web.loadbalancer.healthcheck.interval=30s"
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
        order: start-first
      rollback_config:
        parallelism: 1
        delay: 5s
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
      resources:
        reservations:
          cpus: "0.1"
          memory: 256M

  # ==========================================================================
  # GAME ENGINE - SignalR (Redis Backplane + Sticky Sessions)
  # ==========================================================================
  location404-game:
    image: ${DOCKER_REGISTRY:-ghcr.io/location404}/location404-game:${VERSION:-main}
    build:
      context: ../../location404-game
      dockerfile: Dockerfile

    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:8080

      # Redis (External - Dokploy)
      - Redis__Enabled=true
      - Redis__ConnectionString=${REDIS_CONNECTION}

      # RabbitMQ (External - Dokploy)
      - RabbitMQ__Enabled=true
      - RabbitMQ__HostName=${RABBITMQ_HOST}
      - RabbitMQ__Port=${RABBITMQ_PORT:-5672}
      - RabbitMQ__UserName=${RABBITMQ_USER:-location404}
      - RabbitMQ__Password=${RABBITMQ_PASSWORD:-location404pass}

      # Location404 Data API
      - Location404Data__BaseUrl=http://location404-data:8080

      # OpenTelemetry (External LGTM Stack via Dokploy)
      - OpenTelemetry__ServiceName=location404-game
      - OpenTelemetry__ServiceVersion=${VERSION:-1.0.0}
      - OpenTelemetry__ServiceNamespace=location404
      - OpenTelemetry__Environment=production
      - OpenTelemetry__CollectorEndpoint=http://${OTLP_COLLECTOR_ENDPOINT:-181.215.135.221:4320}
      - OpenTelemetry__Tracing__Enabled=true
      - OpenTelemetry__Tracing__SamplingRatio=${OTLP_SAMPLING_RATIO:-1.0}
      - OpenTelemetry__Metrics__Enabled=true
      - OpenTelemetry__Logging__Enabled=true

    networks:
      - traefik-public
      - location404

    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:8080/health/live",
        ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s

    deploy:
      mode: replicated
      replicas: 1
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.data.rule=Host(`data.${DOMAIN:-location404.local}`) || PathPrefix(`/api/data`)"
        - "traefik.http.routers.data.entrypoints=web"
        - "traefik.http.routers.data.service=data"
        - "traefik.http.services.data.loadbalancer.server.port=8080"
        - "traefik.http.services.data.loadbalancer.healthcheck.path=/health"
        - "traefik.http.services.data.loadbalancer.healthcheck.interval=10s"
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
        order: start-first
      rollback_config:
        parallelism: 1
        delay: 5s
      restart_policy:
        condition: on-failure
        delay: 15s
        max_attempts: 3
        window: 120s
      resources:
        reservations:
          cpus: "0.1"
          memory: 512M

  # ==========================================================================
  # AUTH SERVICE - JWT Authentication
  # ==========================================================================
  location404-auth:
    image: ${DOCKER_REGISTRY:-ghcr.io/location404}/location404-auth:${VERSION:-main}
    build:
      context: ../../location404-auth
      dockerfile: Dockerfile

    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:8080

      # Database
      - ConnectionStrings__UserIdentityDatabaseProduction=${POSTGRES_AUTH_CONNECTION}

      # JWT
      - JwtSettings__Issuer=location404
      - JwtSettings__Audience=location404
      - JwtSettings__SigningKey=${JWT_SIGNING_KEY}
      - JwtSettings__AccessTokenMinutes=60
      - JwtSettings__RefreshTokenMinutes=10080

      # OpenTelemetry (External LGTM Stack via Dokploy)
      - OpenTelemetry__ServiceName=location404-auth
      - OpenTelemetry__ServiceVersion=${VERSION:-1.0.0}
      - OpenTelemetry__ServiceNamespace=location404
      - OpenTelemetry__Environment=production
      - OpenTelemetry__CollectorEndpoint=http://${OTLP_COLLECTOR_ENDPOINT:-181.215.135.221:4320}
      - OpenTelemetry__Tracing__Enabled=true
      - OpenTelemetry__Tracing__SamplingRatio=${OTLP_SAMPLING_RATIO:-1.0}
      - OpenTelemetry__Metrics__Enabled=true
      - OpenTelemetry__Logging__Enabled=true

    networks:
      - traefik-public
      - location404

    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:8080/health/live",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

    deploy:
      mode: replicated
      replicas: 1
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.auth.rule=Host(`auth.${DOMAIN:-location404.local}`) || PathPrefix(`/api/auth`)"
        - "traefik.http.routers.auth.entrypoints=web"
        - "traefik.http.routers.auth.service=auth"
        - "traefik.http.services.auth.loadbalancer.server.port=8080"
        - "traefik.http.services.auth.loadbalancer.sticky.cookie=true"
        - "traefik.http.services.auth.loadbalancer.sticky.cookie.name=location404_auth"
        - "traefik.http.services.auth.loadbalancer.healthcheck.path=/health"
        - "traefik.http.services.auth.loadbalancer.healthcheck.interval=10s"
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
        order: start-first
      rollback_config:
        parallelism: 1
        delay: 5s
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
      resources:
        reservations:
          cpus: "0.1"
          memory: 384M

  # ==========================================================================
  # DATA SERVICE - Locations & Stats
  # ==========================================================================
  location404-data:
    image: ${DOCKER_REGISTRY:-ghcr.io/location404}/location404-data:${VERSION:-main}
    build:
      context: ../../location404-data
      dockerfile: Dockerfile

    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:8080

      # Database
      - ConnectionStrings__GeoDataDatabase=${POSTGRES_DATA_CONNECTION}

      # RabbitMQ (External - Dokploy)
      - RabbitMQ__Enabled=true
      - RabbitMQ__HostName=${RABBITMQ_HOST}
      - RabbitMQ__Port=${RABBITMQ_PORT:-5672}
      - RabbitMQ__UserName=${RABBITMQ_USER:-location404}
      - RabbitMQ__Password=${RABBITMQ_PASSWORD:-location404pass}
      - RabbitMQ__MatchEndedQueue=match-ended

      # OpenTelemetry (External LGTM Stack via Dokploy)
      - OpenTelemetry__ServiceName=location404-data
      - OpenTelemetry__ServiceVersion=${VERSION:-1.0.0}
      - OpenTelemetry__ServiceNamespace=location404
      - OpenTelemetry__Environment=production
      - OpenTelemetry__CollectorEndpoint=http://${OTLP_COLLECTOR_ENDPOINT:-181.215.135.221:4320}
      - OpenTelemetry__Tracing__Enabled=true
      - OpenTelemetry__Tracing__SamplingRatio=${OTLP_SAMPLING_RATIO:-1.0}
      - OpenTelemetry__Metrics__Enabled=true
      - OpenTelemetry__Logging__Enabled=true

    networks:
      - traefik-public
      - location404

    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:8080/health/live",
        ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s

    deploy:
      mode: replicated
      replicas: 1
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.data.rule=Host(`data.${DOMAIN:-location404.local}`) || PathPrefix(`/api/data`)"
        - "traefik.http.routers.data.entrypoints=web"
        - "traefik.http.routers.data.service=data"
        - "traefik.http.services.data.loadbalancer.server.port=8080"
        - "traefik.http.services.data.loadbalancer.healthcheck.path=/health"
        - "traefik.http.services.data.loadbalancer.healthcheck.interval=10s"
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
        order: start-first
      rollback_config:
        parallelism: 1
        delay: 5s
      restart_policy:
        condition: on-failure
        delay: 15s
        max_attempts: 3
        window: 120s
      resources:
        reservations:
          cpus: "0.1"
          memory: 384M
